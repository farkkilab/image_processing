
# White Top-Hat Filtering for Microscopy Image Preprocessing

## Why Filtering Matters
Microscopy images often suffer from **uneven background illumination**, **autofluorescence**, or **haze**.  
These artifacts can obscure small, biologically meaningful structures (e.g., puncta, foci, granules) and make downstream quantification unreliable.

## Why It Is Important
1. **Removes Illumination Gradients**  
   Corrects uneven lighting across the field of view.
2. **Enhances Small Bright Features**  
   Structures such as nuclear foci, vesicles, or small puncta become more distinguishable.
3. **Improves Quantification Robustness**  
   Measurements of intensity per cell are less biased by background variations.

## What Is White Top-Hat Filtering?
White top-hat is defined as: White Top-Hat = Original Image â€“ Morphological Opening(Image, Structuring Element)
- **Opening** smooths the image by removing structures smaller than the structuring element. The structuring element radius (`disk(size)`) can be tuned:
  - **10 px** for 2Ã—2 binned images (recommended default).
   - **20 px** for unbinned images.

## ðŸš€ Quick Start
Run the full pipeline (filter + quantify) in one command:

```bash
python filter_image_script.py pipeline \
    --tif_dir /data/raw_tifs \
    --markers '{"Ki67":7,"DNA1":1,"CD3":4}' \
    --size 10 --workers 8 \
    --mask_dir /data/masks \
    --output_dir /results/quantification

## About This Script
This repository contains a Python script that automates:

1. **Filtering (White Top-Hat)**  
   - Takes raw multi-channel TIFFs.  
   - Applies white top-hat filtering channel-by-channel.  
   - Saves corrected images with the convention:  
     ```
     <tif_dir>/<MARKER>/<SLIDE>.ome_<MARKER>_tophat.tif
     ```
2. **Quantification**  
   - Uses pre-computed cell masks (`<mask_dir>/<SLIDE>.tif`) to measure per-cell marker intensities.  
   - Produces CSV tables (one per slide) with one row per cell and columns for each marker that has been filtered.  
3. **Pipeline Execution**  
   - Run **filter + quantify** in one go for convenience.  

